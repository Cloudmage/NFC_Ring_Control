<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta name = "format-detection" content = "telephone=no"/>
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
	<link rel="stylesheet" type="text/css" href="css/nfcringapp.min.css" />
	<title>NFC Ring App</title>
</head>
<body id="create">

<script type="text/javascript" src="js/parse-1.2.9.min.js"></script>
<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="js/magpop.js"></script>
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript" src="js/index.js"></script>
<script type="text/javascript" src="js/actions.js"></script>
<script type="text/javascript" src="js/heatmap.js"></script>
<script type="text/javascript" src="js/jquery.timeago.js"></script>
<script type="text/javascript">
app.initialize();

nfcRing.coOrds = {};
nfcRing.localSweetSpot = localStorage.getItem("sweetSpotLocation"); // get local sweet spot location
nfcRing.coOrdData = {
  max: 10,
  data: []
};

nfcRing.submitted = function(key, ts){
  var response = $('#optionInput').val() || key;
  if(response){
    nfcRing.location = "writing";
    $('#writeRing').show(); $('#option').hide();
    if(actions[key]){ // if we're using a pre-defined structure
      console.log("Formatted as ", actions[key].format(response));
      nfcRing.toWrite = actions[key].format(response);
    }else{ // if we're using a historic action
      nfcRing.toWrite = key;
    }

    // Store the event in the actionHistory
    nfcRing.actionHistory = localStorage.getItem("actionHistory") || "{}";
    nfcRing.actionHistory = JSON.parse(nfcRing.actionHistory);
    if(ts) delete nfcRing.actionHistory[ts]; // Deletes previous record of this action
    console.log("Previous action History", nfcRing.actionHistory, "pushing ", nfcRing.toWrite);
    var ts = new Date().getTime();
    nfcRing.actionHistory[ts] = nfcRing.toWrite;
    console.log("obj historY", ts, nfcRing.actionHistory);
    nfcRing.actionHistory = JSON.stringify(nfcRing.actionHistory);
    console.log("new action History", nfcRing.actionHistory);
    localStorage.setItem("actionHistory", nfcRing.actionHistory);
    nfcRing.actionHistory = JSON.parse(nfcRing.actionHistory);

    setTimeout(function(){ // TODO use a callback here, using a timeout is ghetto
      $('#heatMap').fadeIn("slow");
      nfcRing.drawHeatMap(); // additional draw request
    }, 500);
  }
}

nfcRing.showNeedHelp = function(){
  $('#message').fadeIn('slow');
}

nfcRing.drawHeatMap = function(){
  console.log("coOrds", nfcRing.coOrds);

  $.each(nfcRing.coOrds, function(k,v){
    var x = k.split(":")[0];
    var y = k.split(":")[1];
    var coOrd = {
      x: x,
      y: y,
      count: v*5
    };
    nfcRing.coOrdData.data.push(coOrd);
  });

  console.log("Loading loacl sweet spot");
  if(nfcRing.localSweetSpot){
    console.log("Found local sweet spot");
    localSweetSpot = JSON.parse(nfcRing.localSweetSpot);
    nfcRing.coOrdData.data.push({x: ""+localSweetSpot.x, y: ""+localSweetSpot.y, count: 10}); // adds 10 weight to the position the user specified
  }

  // heatmap configuration
  var config = {
    element: document.getElementById("heatMap"),
    radius: 30,
    opacity: 100
  };

  console.log("heatmap config", config);

  //creates and initializes the heatmap
  var heatmap = h337.create(config);

  console.log("Writing data to heatmap", nfcRing.coOrdData);

  heatmap.store.setDataSet(nfcRing.coOrdData);
  console.log("Done writing data to the heatmap");
}

$("body").on('click', "#finish", function () {
  debug("Restarting");
  window.location = "index.html";
});

nfcRing.heatmapInit = function(){
  if(nfcRing.heatMapIsInit) return false; // dont init heat map twice.
  nfcRing.heatMapIsInit = true;
  console.log("initting heatmap");
  // Placeholder data object
  var coOrdinateCounter = {};

  // Getting data from Parse..
  var TestObject = Parse.Object.extend("TestObject");
  var testObject = new TestObject();
  var query = new Parse.Query(TestObject);
  try{
    if(!device){return false;}
  }catch(e){
    return false;
  }
  query.equalTo("model", device.model);
  console.log("Model", device.model);
  try{
    query.find({
      success: function(results){
        for (var i = 0; i < results.length; i++) { 
          $('#writeRing > .actionName').html("<h2>Hold your NFC Ring to the back of your phone at the location indicated by the colored dots.</h2>");
          var object = results[i];
          var x = object.get('x');
          var y = object.get('y');
          // Turns it into a counted set of objects instead of single objects
          coOrdinateCounter[x+":"+y] = coOrdinateCounter[x+":"+y] || 1;
        }
        if(results.length == 0){ // if there are no results
          $('#writeRing > .actionName').html("<h2>It looks like our awesome community hasn't stored a location of the NFC Sweet Spot for your phone yet.</h2><p>Move the ring around the back of the phone until you recieve a message telling you that you found your sweet spot.  This can take a little bit of time so be patient :)</p>");
        }else{ // there are some heatmap results so let's draw em
          console.log("Drawing heatmap");
          nfcRing.coOrds = coOrdinateCounter;
          // nfcRing.drawHeatMap();
        }
      },
      failure: function(){
        // fires on failure to connect
        $('#writeRing > .actionName').html("We were unable to connect to our community sweet spot location servers, the sweet spot location will help you identify where to hold the ring on your phone.  You might need to turn on your Internet connection to access our servers, thanks");
        // nfcRing.drawHeatMap();
      }
    });
  }catch(e){
    // Windows Phone wont do the Parse XHR request and fails on access is denied, this should be handled by the Parse API but it isn't so we handle it here
    if(device.platform == "Win32NT"){
      $('#writeRing > .actionName').html("Windows Phone is unable to use our Community Sweet Spot location servers, we hope to get this fixed as soon as possible, sorry");
	  console.log("Unable to process Parse on WP");
      // nfcRing.drawHeatMap();
    }
  }
  console.log("Finished heatmap init");


</script>

<script src="http://10.0.0.12:8080/target/target-script-min.js#anonymous"></script>

<script type="text/javascript" src="js/parseDetails.js"></script>
</body>
</html>
